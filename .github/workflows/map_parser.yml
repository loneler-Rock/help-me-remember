name: Map Saver

on:
  # 1. é€™æ˜¯çµ¦ Make ç”¨çš„ (è‡ªå‹•)
  repository_dispatch:
    types: [save_map]
  
  # 2. é€™æ˜¯çµ¦äººé¡žç”¨çš„ (æ‰‹å‹•)
  workflow_dispatch:
    inputs:
      test_url:
        description: 'åœ¨æ­¤è¼¸å…¥è¦æ¸¬è©¦çš„ç¶²å€'
        required: true
        default: 'https://goo.gl/maps/example'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Map Handler
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        run: |
          echo "ðŸ—ºï¸ [åœ°åœ–æ ¸å¿ƒ] å•Ÿå‹•..."
          
          # --- æ™ºæ…§åƒæ•¸åˆ‡æ› ---
          # å¦‚æžœæ˜¯ Make å‚³ä¾†çš„ (client_payload æœ‰å€¼)ï¼Œå°±ç”¨ Make çš„è³‡æ–™
          # å¦‚æžœæ˜¯æ‰‹å‹•æŒ‰çš„ (inputs æœ‰å€¼)ï¼Œå°±ç”¨æ‰‹å‹•è¼¸å…¥çš„è³‡æ–™
          
          # 1. è¨Šæ¯å…§å®¹ (Message)
          MSG="${{ github.event.client_payload.message_text || github.event.inputs.test_url }}"
          
          # 2. User ID (æ‰‹å‹•æ¸¬è©¦æ™‚ç”¨ 'manual_test_user')
          UID="${{ github.event.client_payload.user_id || 'manual_test_user' }}"
          
          # 3. Reply Token (æ‰‹å‹•æ¸¬è©¦æ™‚çµ¦ç©ºå€¼ï¼Œé€™æ¨£ Python å°±ä¸æœƒå ±éŒ¯èªªå›žè¦†å¤±æ•—)
          TOKEN="${{ github.event.client_payload.reply_token || '' }}"

          echo "æ¸¬è©¦æ¨¡å¼: è¼¸å…¥å…§å®¹ -> $MSG"
          
          # åŸ·è¡Œ Python
          python ig_map/main.py "$MSG" "$UID" "$TOKEN"
