name: Map Saver

on:
  repository_dispatch:
    types: [save_map]
  workflow_dispatch:
    inputs:
      test_url:
        description: 'åœ¨æ­¤è¼¸å…¥è¦æ¸¬è©¦çš„ç¶²å€'
        required: true
        default: 'https://goo.gl/maps/example'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Map Handler
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        run: |
          echo "ðŸ—ºï¸ [åœ°åœ–æ ¸å¿ƒ] å•Ÿå‹•..."
          
          # --- è®Šæ•¸åç¨±ä¿®æ­£ (UID -> USER_ID) ---
          
          # 1. è¨Šæ¯å…§å®¹ (Message)
          MSG="${{ github.event.client_payload.message_text || github.event.inputs.test_url }}"
          
          # 2. User ID (ä¿®æ­£è®Šæ•¸åç¨±ï¼Œé¿å…è¡çª)
          USER_ID="${{ github.event.client_payload.user_id || 'manual_test_user' }}"
          
          # 3. Reply Token
          TOKEN="${{ github.event.client_payload.reply_token || '' }}"

          echo "æ¸¬è©¦æ¨¡å¼: è¼¸å…¥å…§å®¹ -> $MSG"
          
          # åŸ·è¡Œ Python (å‚³å…¥ USER_ID)
          python ig_map/main.py "$MSG" "$USER_ID" "$TOKEN"
