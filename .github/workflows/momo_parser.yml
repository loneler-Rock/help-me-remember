name: Momo Price Tracker

on:
  # 1. LINE è§¸ç™¼ (åŸæœ¬çš„åŠŸèƒ½)
  repository_dispatch:
    types: [momo_task]
  
  # 2. å®šæ™‚è§¸ç™¼ (æ–°å¢åŠŸèƒ½: æ¯å¤©å°ç£æ™‚é–“æ—©ä¸Š 08:00)
  # UTC æ™‚é–“ 00:00 = å°ç£æ™‚é–“ 08:00
  schedule:
    - cron: '0 0 * * *'
    
  # 3. æ‰‹å‹•è§¸ç™¼ (æ–°å¢åŠŸèƒ½: æ–¹ä¾¿ä½ åœ¨ GitHub ç¶²é ä¸ŠæŒ‰æŒ‰éˆ•æ¸¬è©¦)
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      # ä¿ç•™ä½ åŸæœ¬çš„ Chrome è¨­å®šï¼Œé€™å¾ˆé‡è¦
      - name: Setup Chrome
        uses: browser-actions/setup-chrome@latest
          
      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Momo Parser
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šæ™ºæ…§åˆ¤æ–·è§¸ç™¼ä¾†æº â˜…â˜…â˜…
          
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "ğŸš€ è§¸ç™¼æ¨¡å¼: LINE æ–°å¢å•†å“"
            # å¦‚æœæ˜¯ LINE ä¾†çš„ï¼Œå°±æŠŠç¶²å€å’Œ UserID å‚³é€²å»
            python momo_price/main.py "${{ github.event.client_payload.url }}" "${{ github.event.client_payload.user_id }}"
          
          else
            echo "â° è§¸ç™¼æ¨¡å¼: å…¨åº«æƒæ (æ’ç¨‹/æ‰‹å‹•)"
            # å¦‚æœæ˜¯æ’ç¨‹æˆ–æ‰‹å‹•ï¼Œä¸å‚³åƒæ•¸ï¼Œè®“ Python è·‘ check_all_products()
            python momo_price/main.py
          fi
